:source-highlighter: highlights
:data-uri:
:toc:

== Drools & jBPM examples for OSGi platforms (JBoss Fuse, Karaf, Fabric8)

toc::[]

This project contains Drools & jBPM OSGi examples that you can deploy on :
supported release
- https://www.jboss.org/products/fuse.html[RedHat JBoss Fuse 6.1]
or community releases
- http://karaf.apache.org[Apache Karaf]
- http://fabric8.io/[Fabric 8 - Community project of RedHat JBoss Fuse]

== Download and compile the project

- In a Dos/Unix terminal, clone this git project

  git clone https://github.com/cmoulliard/droolsjbpm-osgi-examples.git

- Move to that directory

  cd droolsjbpm-osgi-examples

- Compile it using `maven`

  mvn clean install
  
== Download and deploy on RedHat JBoss Fuse

- Open a browser at the following address : https://www.jboss.org/products/fuse.html
- Download `JBoss Fuse 6.1`
- Unzip it under your local temp directory *~/temp*
- Change to the JBoss Fuse bin directory

  cd ~/temp/jboss-fuse-6.1.0.redhat-379/bin

- Start Fuse console

  ./fuse
  
== Download and deploy on Apache Karaf/Fabric8

Procedure is exactly the same excepted that you should download *Apache Karaf* or *Fabric8* releases

- http://karaf.apache.org/index/community/download.html[Karaf 2.3.5]
- http://fabric8.io/#/site/book/doc/index.md?chapter=getStarted_md[fabric8-karaf-1.1.0.Beta5 or more]

== Add Repositories of the modules

In the JBoss Fuse/Karaf console, add the url pointing to the file containing the description of the Drools/jBPM OSGI modules

  features:addurl mvn:org.drools.example/features/1.0.0-SNAPSHOT/xml/features

Now you are ready to start to play with different examples described hereafter !

== Drools OSGi Example

=== Simple Rule Example

To test the simple rule example which is a Drools example using a rule DRL

[source,java]
----
rule "CanDrink"
when
    p : Person( age >= 21 )
then
	p.setCanDrink(true);
end
----    

where we will check if a person can drink, we will deploy the module `simple-rule`. This module
which is a feature will install the code of the bundle `simple-rule` but also `drools core & compiler`
like `kie` project (api & internal)

  features:install simple-rule

After a few moment, you will see that the `bundle` has been installed and started as the Activator class will report the following message

    KieSession created.

corresponding to the KieSession created by Kie & Drools after discovering the META-INF/kmodule.xml file containing the location of the resources
to be loaded by Drools (Rule, ...).
This session is created as the start method of the bundle activator class contains the code to create a KieContainer, KieBaseConfiguration & KieBase

[source,java]
----
KieServices ks = KieServices.Factory.get();
KieBaseConfiguration kbaseConfig = ks.newKieBaseConfiguration(null, this.getClass().getClassLoader());
KieBase kbase = ks.newKieClasspathContainer().newKieBase(kbaseConfig);

this.ksession = kbase.newKieSession();
----

Next, 20 persons will be generated randomly by a function which, added to a KieSession and rule fired
to verify if they can Drink according to their age.

    Person Young Person aged of 18, can't go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Young Person aged of 18, can't go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Old Person aged of 21 , can go to the Bar
    Person Young Person aged of 18, can't go to the Bar

Remark : When you stop the bundle 'simple-rule', the Kie Session is stopped and this message appears in the console of Karaf

    KieSession disposed

=== Externalise the rules assets

One of the benefit of an OSGI platform is that the bundles (= jar file + META DATA defined in the MANIFEST.mf file) are isolated form
each other as they run within their own classloader. That means that we can split a Drools & Kie project into a collection of bundles: one containing
the logic and the Kie classes to build the container hosting the KieBase (= assets), KieSessions (= in cache memory of the facts/objects) while the
assets can be packaged in a separate bundle. This approach allows the business user to produce the jar containing the rules, decision tables, ...
according to a procedure (= release management) which is independent from the one followed by developer team to design/develop the project.
As the assets will be deployed in a separate bundle, they can be updated without changing the code of the project.

This demo which uses the same code as the example "Simple Rule Example" but it has been packaged into 2 bundles.

The assets

image:documentation/images/assets.png[]

and the Kie

image:documentation/images/kie-bundle.png[]

The project can be deployed using this feature command

    features:install simple-import-rule

=== Simple XLS Decision Table with a Rule Example

As Drools supports to externalize rules in a XLS Decision Table, this example will demonstrate how such a project can be packaged
as an OSGi bundle. Compared to the previous example, the rule is not defined in a file where the extension ends with .drl but in a XLS file

image:documentation/images/decision-table.png[]

The XLS Table contains a rule to checks Type of the Cheese. This file is located under this directory `resources/org.drools.example.cheese` and
the `resources/META-INF/kmodules.xml file contains the definition about the project to be scanned before to create the KieBase, KieSession

[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<kmodule xmlns="http://jboss.org/kie/6.0.0/kmodule">

    <kbase name="sampleKBase" packages="org.drools.example.cheese" default="true">
        <ksession name="sampleKSession" default="true" />
    </kbase>
</kmodule>
----

The code of the OSGI Bundle Activator used when the OSGI Container starts the bundle and calls the events `start`or `stop` are similar to what has been created
  for the `simple-rule`project

[source,java]
----
public void start(final BundleContext bc) throws Exception {

    KieServices ks = KieServices.Factory.get();
    KieBaseConfiguration kbaseConfig = ks.newKieBaseConfiguration(null, this.getClass().getClassLoader());
    Thread.currentThread().setContextClassLoader(getClass().getClassLoader());
    KieBase kbase = ks.newKieClasspathContainer().newKieBase(kbaseConfig);

    this.ksession = kbase.newKieSession();
    System.out.println("KieSession created.");

    for (int i = 0; i < 10; i++) {
        // Create a Cheese
        Cheese aCheese = EntityHelper.createCheese();
        ksession.insert(aCheese);

        // Fire the rules
        ksession.fireAllRules();

        // Check Cheese Price
        EntityHelper.cheesePrice(aCheese);
    }

    System.out.println("Cheese added and rules fired.");
}
----

To deploy this module on the container, use this Karaf command which will install `decision-table` module and the example.
When the bundle will be started, this information will appear in the Karaf Console

    karaf@root> features:install simple-decisiontable-rule
    KieSession created.
    Cheese Stilton costs 10 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Stilton costs 10 EUR.
    Cheese Stilton costs 10 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Stilton costs 10 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Stilton costs 10 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Stilton costs 10 EUR.

=== External XLS Decision Table

As Rules will be designed by business analysts in a company, they will prefer to use a XLS Spreadsheet document that they will provide
 to the project (developer, ...) as artefact to be used by the application to calculate decision. In the previous example, the decision table
 was embedded, packaged into the jar file generated during the build of the application. While this approach is fine, it implies that the project must
 rebuild (regenerate a jar/zip file) every time we have a new update the decision table.
 This example allows you to externalize the location of the decision table. The only thing to be done is to change this variable in the code

[source,java]
----
package org.drools.example.osgi;
public class FetchExternalResourceOsgiActivator implements BundleActivator {
    private static final String EXTERNAL_XLS_RESOURCE = "file:///Users/chmoulli/MyProjects/droolsjbpm-osgi-examples/documentation/decision-table/cheeseDecisionTable.xls";
----

to point to your XLS file on the file system, before to build the project and deploy on it Karaf, JBoss Fuse.

Project can be deployed using the following Karaf command :

    features:install fetch-external-resource

And after rules calculation, the following result will be displayed

    Cheese Cheddar costs 50 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Stilton costs 10 EUR.
    Cheese Stilton costs 10 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese Cheddar costs 50 EUR.
    Cheese added and rules fired.

For later update of the XLS file, the bundle used for this example must be restarted to create new Session and load new Rules definition

    osgi:restart ID_OF_THE_BUNDLE

== jBPM OSGi Example

=== Simple Process

jbpmn process is also supported and can be deployed too on Karaf, JBoss Fuse container. Like the Drools Simple Rule Example, you should install a feature
which will install the bundles required (jbpm, Human-task, ...) and finally the example

    features:install simple-process

The process is simple and start by logging information that process has been initiated before to diverge, register a request and finally converge at the end

c

To configure the runtime manage with the bpmn process file, you should add assets using a `ResourceFactory.newClassPathResource` with the package name containing it

[source,java]
----
RuntimeEnvironment environment = RuntimeEnvironmentBuilder.getEmpty()
        .addAsset(ResourceFactory.newClassPathResource(process,getClass().getClassLoader()), ResourceType.BPMN2)
        .get();
return RuntimeManagerFactory.Factory.get().newSingletonRuntimeManager(environment);

The parameters used by the business process like also the tasks are configured like that

runtimeEngine = runtimeManager.getRuntimeEngine(EmptyContext.get());
ksession = runtimeEngine.getKieSession();

LOG.info("Register tasks");
ksession.getWorkItemManager().registerWorkItemHandler("Human Task", new SystemOutWorkItemHandler());
ksession.getWorkItemManager().registerWorkItemHandler("Register Request", new SystemOutWorkItemHandler());

Map<String, Object> params = new HashMap<String, Object>();
params.put("employee", "UserId-12345");

LOG.info("Start process Evaluation (bpmn2)");
ProcessInstance processInstance = ksession.startProcess("Evaluation", params);
LOG.info("Stated completed");
----

== Integration with Camel Example

The Drools/jBPM has developed different kie modules that you can use to integrate this technology with Apache Camel to collect
the information needed to prepare the facts/objects that we will next inserted into the KieSessions.

=== Kie Spring with Camel & Drools

This example combines the http://camel.apache.org[Camel Java Integration framework] with Drools and Spring (IoC framework) to insert the facts/objects into a KieSession
created and managed by camel. The objects created (= Person) whenever they are inserted in the KieSession will be

To run the project on JBoss Fuse, simply run this features:install command to deploy the bundles. After being deployed the bundle containing the
camel routes definition will be started and the camel timer component will fire events every 10s to request to create a Person object or Cheese object as we have 2 camel routes.

[source, xml]
----
<route trace="false" id="testRoute">
  <description>Example route that will regularly create a Person with a random age and verify their age
  </description>
  <from uri="timer:testRoute?period=10s"/>
  <bean method="createTestPerson" ref="personHelper"/>
  <to uri="kie:ksession1?action=insertBody" id="AgeVerification"/>
  <choice>
    <when id="CanDrink">
      <simple>${body.canDrink}</simple>
      <log logName="Bar" message="Person ${body.name} can go to the bar"/>
    </when>
    <otherwise>
      <log logName="Home" message="Person ${body.name} is staying home"/>
    </otherwise>
  </choice>
</route>
----

One camel route is used by Drools and the other by Drools DecisionTable.

The object created (= fact) is inserted into the KieSession used by Drools and when this is done the rules will be fired automatically.
To play with the project, use the following `features:install` command to deploy the bundles on JBoss Fuse.

features:install drools-decisiontable-kie-spring-camel

=== Kie Blueprint with Camel & Drools

Same example as described before but instead of Spring Dynamic Module priject, we will setup the project using the http://www.ibm.com/developerworks/library/os-osgiblueprint/[OSGI Blueprint container]
to instantiate the beans required to start the CamelContext containing the camel routes like also the beans handling the business logic (PersonHelper, CheeseHelper, ...).

features:install drools-decisiontable-kie-blueprint-camel

Enjoy it !
